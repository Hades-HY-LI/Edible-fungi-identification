# Confusion matrix and test accuracy
# Reference: https://stackoverflow.com/questions/53290306/confusion-matrix-and-test-accuracy-for-pytorch-transfer-learning-tutorial

def confusion_matrix(model_ft, nb_classes, phase="test"):
    """
    given a pytorch model (model_ft), calculate confusion matrix (a torch tensor object)

    Arguments
    ---------
    model_ft:     pytorch model from torchvision

    nb_classes:   number of classes

    phase:        get the confusion matrix for 'test' or 'validation'
    """
    nb_classes = nb_classes
    confusion_matrix = torch.zeros(nb_classes, nb_classes)
    with torch.no_grad():
        for i, (inputs, classes) in enumerate(dataloaders[phase]):
            inputs = inputs.to(device)
            classes = classes.to(device)
            outputs = model_ft(inputs)
            _, preds = torch.max(outputs, 1)
            for t, p in zip(classes.view(-1), preds.view(-1)):
                confusion_matrix[t.long(), p.long()] += 1
    return confusion_matrix
